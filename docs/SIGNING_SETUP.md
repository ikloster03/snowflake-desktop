# Настройка подписи для автоматических обновлений

## Генерация ключей подписи

1. Сгенерируйте пару ключей для подписи:
```bash
pnpm tauri signer generate -w ~/.tauri/snowflake.key
```

Эта команда создаст два файла:
- `~/.tauri/snowflake.key` - приватный ключ (держите в секрете!)
- `~/.tauri/snowflake.key.pub` - публичный ключ

**Важно:** При генерации ключа вы можете установить пароль или оставить его пустым. Если устанавливаете пароль, запомните его - он понадобится для настройки GitHub Secrets.

## Настройка GitHub Secrets

1. Перейдите в настройки вашего репозитория на GitHub
2. Выберите "Secrets and variables" → "Actions"
3. Добавьте следующие секреты:

### TAURI_SIGNING_PRIVATE_KEY (обязательно)
- Скопируйте **полное содержимое** файла `~/.tauri/snowflake.key`

### TAURI_SIGNING_PRIVATE_KEY_PASSWORD (только если установлен пароль)
- Если при генерации ключа вы установили пароль, добавьте его как отдельный секрет
- Если пароль не устанавливали, этот секрет не нужен

## Настройка публичного ключа в Tauri

1. Скопируйте содержимое файла `~/.tauri/snowflake.key.pub`
2. Обновите `src-tauri/tauri.conf.json`:

```json
{
  "plugins": {
    "updater": {
      "active": true,
      "endpoints": [
        "https://github.com/ikloster03/snowflake-desktop/releases/latest/download/latest.json"
      ],
      "dialog": true,
      "pubkey": "СОДЕРЖИМОЕ_ПУБЛИЧНОГО_КЛЮЧА_ЗДЕСЬ"
    }
  }
}
```

## Как работает система подписи

1. **Сборка:** При сборке Tauri автоматически создает `.sig` файлы для каждого ассета
2. **Публикация:** Workflow сначала публикует релиз, затем создает `latest.json`
3. **Подписи:** `latest.json` содержит правильные подписи, полученные из `.sig` файлов
4. **Обновления:** Приложение проверяет подписи перед установкой обновлений

## Проверка настройки

После настройки секретов:

1. Создайте новый тег и запустите релиз
2. Проверьте, что в релизе появились `.sig` файлы для каждого ассета
3. Убедитесь, что `latest.json` содержит непустые подписи
4. Проверьте логи GitHub Actions на предмет ошибок

### Диагностика проблем

**Если подписи пустые:**
- Проверьте, что `TAURI_SIGNING_PRIVATE_KEY` правильно настроен в GitHub Secrets
- Убедитесь, что публичный ключ в `tauri.conf.json` соответствует приватному ключу
- Проверьте логи сборки на предмет ошибок подписи

**Если обновления не работают:**
- Проверьте, что endpoint в `tauri.conf.json` указывает на правильный URL
- Убедитесь, что `latest.json` доступен по указанному URL
- Проверьте консоль приложения на предмет ошибок валидации подписи

## Важные замечания

⚠️ **Безопасность:**
- Никогда не делитесь приватным ключом
- Сохраните резервную копию ключа в безопасном месте
- Если ключ будет утерян, пользователи не смогут получать автоматические обновления

✅ **Автоматическая работа:**
- После настройки подписи будут генерироваться автоматически для каждого релиза
- Workflow правильно обрабатывает порядок операций для получения подписей
- Файл `latest.json` будет содержать правильные подписи для всех платформ
- Система автоматических обновлений будет работать корректно 
